name: ðŸ‰ â€¢ Tests
on:
  workflow_call:

jobs:
  mlir:
    name: >-
      ${{ contains(matrix.os, 'ubuntu') && 'ðŸ§' || 'ðŸŽ' }}
      ${{ matrix.coverage && 'Coverage' || matrix.os }}
    runs-on: ${{ matrix.os }}
    permissions:
      contents: read
      id-token: write
    strategy:
      fail-fast: false
      matrix:
        os: [macos-14] # TODO: enable after debugging [ubuntu-24.04, ubuntu-24.04-arm, macos-14]
        coverage: [false]
        include:
          - os: ubuntu-24.04
            coverage: true
    env:
      CMAKE_BUILD_PARALLEL_LEVEL: 4
      FORCE_COLOR: 3
    steps:
      - name: Checkout
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          fetch-depth: 0

      # Set up MLIR
      - name: Set up MLIR
        uses: munich-quantum-software/setup-mlir@refs/pull/32/head # TODO: update 2025.12.12
        with:
          llvm-version: "f8cb7987c64dcffb72414a40560055cb717dbf74"

      # Build acceleration and Python tooling
      - name: Set up ccache
        uses: Chocobo1/setup-ccache-action@85ed78428a2cf784edc1d4cb9c784af4bc9baaab # v1.5.1
        with:
          prepend_symlinks_to_path: false
          override_cache_key: mlir-coverage

      - name: Set up mold as linker (Linux)
        uses: rui314/setup-mold@725a8794d15fc7563f59595bd9556495c0564878 # v1

      - name: Install the latest version of uv
        uses: astral-sh/setup-uv@1e862dfacbd1d6d858c55d9b792c756523627244 # v7.1.4
        with:
          python-version: 3.13
          activate-environment: true
          enable-cache: true
          save-cache: ${{ github.ref == 'refs/heads/main' }}

      - name: Install Ninja
        run: uv tool install ninja

      - name: Install dependencies
        run: uv pip install lit pennylane-catalyst~=0.13.0

      # Configure
      - name: Configure CMake
        run: |
          PYTHON_EXE=$(uv python find)
          echo "Python executable: $PYTHON_EXE"
          cmake -G Ninja -S . -B build \
            -DCMAKE_BUILD_TYPE=${{ matrix.coverage && 'Debug' || 'Release' }} \
            -DLLVM_EXTERNAL_LIT=$(dirname $PYTHON_EXE)/lit \
            -DPython3_EXECUTABLE=$PYTHON_EXE \
            ${{ matrix.coverage && '-DENABLE_COVERAGE=ON' || '' }}

      # Build
      - name: Build lit test dependencies
        run: cmake --build build --config ${{ matrix.coverage && 'Debug' || 'Release' }} --target mqt-core-plugins-catalyst-lit-test-build-only

      # Test
      - name: Run lit tests
        run: cmake --build build --config ${{ matrix.coverage && 'Debug' || 'Release' }} --target mqt-core-plugins-catalyst-lit-test

        # Coverage
      - name: Generate coverage data as JSON (gcovr)
        if: matrix.coverage
        run: |
          uvx gcovr \
              --gcov-executable "llvm-cov gcov" \
              --exclude build \
              --exclude-unreachable-branches \
              --exclude-noncode-lines \
              --exclude-throw-branches \
              --print-summary \
              --keep \
              --json \
              -o mlir-coverage.json

      - name: Upload coverage to Codecov
        if: matrix.coverage
        uses: codecov/codecov-action@5a1091511ad55cbe89839c7260b706298ca349f7 # v5.5.1
        with:
          flags: mlir
          name: mlir-coverage
          fail_ci_if_error: true
          use_oidc: ${{ !(github.event_name == 'pull_request' && github.event.pull_request.head.repo.fork) }}
          files: mlir-coverage.json

  lint:
    name: ðŸš¨ Lint
    runs-on: ubuntu-24.04
    env:
      CLANG_VERSION: 18
    steps:
      - name: Checkout
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          fetch-depth: 0

      - name: Set up MLIR
        uses: munich-quantum-software/setup-mlir@refs/pull/32/head # TODO: update 2025.12.12
        with:
          llvm-version: "f8cb7987c64dcffb72414a40560055cb717dbf74"

      - name: Set up mold as linker
        uses: rui314/setup-mold@725a8794d15fc7563f59595bd9556495c0564878 # v1

      - name: Install the latest version of uv
        uses: astral-sh/setup-uv@1e862dfacbd1d6d858c55d9b792c756523627244 # v7.1.4
        with:
          python-version: 3.13
          activate-environment: true
          enable-cache: true
          save-cache: ${{ github.ref == 'refs/heads/main' }}

      - name: Install Ninja
        run: uv tool install ninja

      - name: Set up Clang 18
        env:
          TEMP_DIR: ${{ runner.temp }}
        run: |
          clang_version=18
          sudo apt-get update
          wget https://apt.llvm.org/llvm.sh -O "$TEMP_DIR/llvm_install.sh"
          chmod +x "$TEMP_DIR/llvm_install.sh"
          if sudo "$TEMP_DIR/llvm_install.sh" "$clang_version"; then
            sudo apt-get install -y clang-"$clang_version" \
                                    clang-format-"$clang_version" \
                                    clang-tidy-"$clang_version" \
                                    clang-tools-"$clang_version" \
            || exit 1
          else
            echo "Installation from script failed."
            exit 1
          fi
          echo "CC=clang-$clang_version" >> $GITHUB_ENV
          echo "CXX=clang++-$clang_version" >> $GITHUB_ENV

      - name: Install dependencies
        run: uv pip install lit pennylane-catalyst~=0.13.0

      - name: Generate compilation database
        run: |
          PYTHON_EXE=$(uv python find)
          cmake -G Ninja -S . -B build \
            -DCMAKE_BUILD_TYPE=Debug \
            -DLLVM_EXTERNAL_LIT=$(dirname $PYTHON_EXE)/lit \
            -DPython3_EXECUTABLE=$PYTHON_EXE \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
            -DCMAKE_CXX_FLAGS="-Wall -Wextra -Wduplicated-branches -Wpedantic -fdiagnostics-color=always"

      - name: Build MLIR targets (verbose)
        run: cmake --build build --config Debug -- VERBOSE=1

      - name: Run cpp-linter
        uses: cpp-linter/cpp-linter-action@a645cdb1ded4f83d2a4af4b0e7929546bb040bea # v2.16.6
        id: linter
        env:
          GITHUB_TOKEN: ${{ github.token }}
        with:
          style: ""
          tidy-checks: ""
          version: 18
          ignore: "build|!build/mlir/**|**/include"
          thread-comments: ${{ github.event_name == 'pull_request' && 'update' }}
          step-summary: true
          database: "build"
          extra-args: "-std=c++20"
          files-changed-only: true

      - name: Fail if linter found errors
        if: steps.linter.outputs.checks-failed > 0
        run: echo "Linter found errors" && exit 1
